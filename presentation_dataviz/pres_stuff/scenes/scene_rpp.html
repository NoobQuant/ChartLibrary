<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">


<!-- Basic utilities of AnimationLib-->
<script type="text/javascript" src="../../pres_stuff/basic_utils/basic_utils.js"></script> 

<!-- d3-->
<script src="https://d3js.org/d3.v4.js" charset="utf-8"></script>

<!-- Math symbols-->
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_SVG">
</script>

<!-- Convenience for multi-value syntax to selections and transitions, allowing you to set multiple attributes, styles or properties simultaneously-->
<script src="https://d3js.org/d3-selection-multi.v0.4.min.js"></script>

<!-- Grids-->
<script src="http://romsson.github.io/d3-gridding/build/d3-gridding.js"></script>


</head>

<style>

.axisColored line{
  stroke: #FFFFFF;
}

.axisColored path{
  stroke: #FFFFFF;
}




</style>

<body>


<script>

    var width = 1920,
        height = 1080;

    var rectinitopa = 0.0;

    svg = d3.select("body").append("div").append("svg")
        // Scalable svg 
        .attr('viewBox','0 0 ' + width + ' ' + height)
        .attr('preserveAspectRatio','xMidYMid meet')
        .style("width", '98%')
        .style("height", '98%')
        .style("display", "block")
        .style("position", "absolute");

    // main title
    var titleparams = {
        pos: [[250,400]]
        ,scales: [1,3]
        ,id: "maintitle"
        ,textAreaWidth: 1500
        ,textAreaHeight: 800
        //,textRelXPos: 0
        ,text: "Visualization on residential property price and household<br>indebtedness evolution in DK, FI, SE and GR"
        ,scaleEase: "d3.easeBounce"
        ,fontSize: 50
        ,textAlign: "center"
        ,fontFamily: "FontAwesome"
        //,pads: [20,20,20,0]
        ,rectStroke: "none"
        ,textColor: "#ef980b"
    };

    var maintitle =  new TextField(titleparams);
    maintitle.Draw(0, duration = 1500);



    // Text for radius
    var tfParams = {
     pos: [[350,100]]
    ,id: "tf"
    ,textAreaWidth: 700
    ,textAreaHeight: 170
	,text: "Radius of circles indicates estimated residential property price overvaluation.<br>The greater the radius, the more overvalued property prices are, and vice versa.<br>Source of data: ECB Data Warehouse and Eurostat. <a href='https://github.com/NoobQuant/Data_Science_Projects/blob/master/macropru/code_for_analysis.ipynb'>Link to analysis.</a>"
	//,scaleEase: "d3.easeBounce"
	,fontSize: 20
	,rectStroke: "none"
	,textColor: "#70a8e0"
    };
    tf =  new TextField(tfParams);
    tf.Draw(0, duration = 0);

    // Logger siplaying current prob
    var fo = svg
        .append('foreignObject')
        .attr('x',350) 
        .attr('y',200)
        .attr('width',400)
        .attr('height',200);

    var div = fo.append('xhtml:div')
                .attr('id','log')
                .style("font-family",'Lucida Sans Unicode')				
                .style("font-size", 60 + "px")
                .style("color", 'skyblue');

    // Logger function from console output
    (function () {
        var logger = document.getElementById('log');
        console.log = function () {
        for (var i = 0; i < arguments.length; i++) {
            if (typeof arguments[i] == 'object') {
                logger.innerHTML = (JSON && JSON.stringify ? JSON.stringify(arguments[i], undefined, 2) : arguments[i]);            
            } else {
                //logger.innerHTML = arguments[i];            
                logger.innerHTML = arguments[i];
            }
        }
        }
    })();                



    function maprange(inputval){
        var inputrange = [-20, 40]
        var outputrange = [0.3, 4]
        return (inputval - inputrange[0]) * ( (outputrange[1] - outputrange[0]) / (inputrange[1] - inputrange[0]) ) + outputrange[0]       

    }

    var dataset2;

    d3.json("pics/data_export.json", function(error, data) {          
        if (error) throw error;
    

        var realdata = []
        for (var h = 0; h < data.length; h++){

            var realdatatemp = [];
            realdatatemp.push([data[h].DK_RPP, Math.floor(data[h].DK_RPV), data[h].DK_debt, 'DK'])
            realdatatemp.push([data[h].FI_RPP, Math.floor(data[h].FI_RPV), data[h].FI_debt, 'FI']) 
            realdatatemp.push([data[h].GR_RPP, Math.floor(data[h].GR_RPV), data[h].GR_debt, 'GR'])
            realdatatemp.push([data[h].SE_RPP, Math.floor(data[h].SE_RPV), data[h].SE_debt, 'SE'])    
            
            realdata.push(realdatatemp)
        };




        var xpoint = 250
        var ypoint = 100  
        var xrange =  [0,1400]
        var yrange =  [0,800]  
        var xdomain = [90,150]
        var ydomain = [50,230]
        var yrangeinv = [yrange[1], yrange[0]]  

        // Create scale functions
        var xScale = d3.scaleLinear().domain(xdomain).range(xrange); // output range
        var yScale = d3.scaleLinear().domain(ydomain).range(yrangeinv); // output range

        // Define X axis
        var xAxis = d3.axisBottom().scale(xScale).ticks(5);

        // Define Y axis
        var yAxis = d3.axisLeft()
                        .scale(yScale)
                        .ticks(5);



        var plot = svg.append("g")
            .attr("transform", "translate(" + xpoint + "," + ypoint + ")");
        
            // x-axis
        plot.append("g")
            .attr("class", "axisColored")
            .attr("transform", "translate("+ yrange[0] + "," + yrange[1] + ")")      
            .call(xAxis)
            .selectAll("text")
					.style("font-size", 20)
                    .style("fill",'white');    
                    
        plot.append("g")
		  .style("text-anchor", "middle")
		  .attr("transform","translate(" + (xrange[1]/2 - 250) + " ," + (yrange[1] + 60 ) + ")")
    	  .append("g")
    	  	  .attr("class", "mathjax")
			  .style("font-size", 150 + "%") 
			  .style("color", "white")  	  	  
	    	  .append("text")  	
	    	  .text("$\\text{Household indebtedness, loans per GDP (index 2007Q1 = 100)}$");                    

        // y-axis
        plot.append("g")
            .attr("class", "axisColored")        
            .call(yAxis)
            .selectAll("text")
					.style("font-size", 20)
					.style("fill",'white')


		plot.append("g")
			.style("text-anchor", "middle")
			.attr("transform",
					"translate(" + (xrange[0] - 100) + " ," + (yrange[1] / 2 + 250) + ") rotate(-90)")
			.append("g")
				.attr("class", "mathjax")
				.style("font-size", 150 + "%") 
				.style("color", 'white')  	  	  
				.append("text")  	
				.text("$\\text{Residental property prices (index 2007Q1 = 100)}$");



    var svgDefs = plot.append('defs');

        for (var k = 0; k <= 3; k++){

                var pathname;
                if (k == 0){
                     pathname = 'pics/denmark.svg'
                } else if (k == 1){
                    pathname = "pics/finland.svg"                     
                } else if (k == 2){
                    pathname = "pics/greece.svg"                     
                } else if (k == 3){
                    pathname = "pics/sweden.svg"                                         
                }            

            svgDefs.append('pattern')
                .attr('id', "image" + k.toString())
                .attr('x', 0)
                .attr('y', 0)
                .attr('width', 40)
                .attr('height', 40)
                .attr("patternUnits", "userSpaceOnUse")               

                .append('image')
                .attr('x', 0)
                .attr('y', 0)
                .attr('width', 40)
                .attr('height', 40)      
                .attr("xlink:href",pathname); 
        }   

        // Create Circles
        plot.selectAll("circle")
            .data(realdata[0])      
            .enter()
            .append("circle")
            .style("fill", "#fff")
            .style('fill', function(d){
                if (d[3] == 'DK'){
                    return "url(#image0)" 
                } else if (d[3] == 'FI'){
                    return "url(#image1)"                     
                } else if (d[3] == 'GR'){
                    return "url(#image2)"
                } else if (d[3] == 'SE'){
                    return "url(#image3)"                                                             
                }
            })       
            .style("stroke", 'white')
            .style("stroke-width", 3)
            .attr("cx", -20)
            .attr("cy", -20)
            .attr("r", 20)

        var timing = 0

        timing = timing + 10000;

        maintitle.Hide(timing, duration = 900);
        


        var text1params = {
            pos: [[400,400]]
            ,scales: [1,3]
            ,id: "text1"
            ,textAreaWidth: 1300
            ,textAreaHeight: 500
            //,textRelXPos: 0
            ,text: "All circles will start from index position 100 on both x-axis (indebteness) and y-axis (property prcies).<br>Radius of circles indicates estimated residential property price overvaluation."
            ,fontSize: 30
            //,textAlign: "center"
            ,fontFamily: "FontAwesome"
            //,pads: [20,20,20,0]
            ,rectStroke: "none"
            ,textColor: "#ef980b"
        };
        var text1 =  new TextField(text1params);
        timing = timing + 1500;        
        text1.Draw(timing, duration = 500);
        timing = timing + 10000;                        
        text1.Hide(timing, duration = 500);


        timing = timing + 1000;      
        var currentDate = new Date(2007, 1, 1);
        var iter = 1;
        d3.timeout(() => {
            var interval =  d3.interval(() => {
                    interval_anim(realdata[iter])
                    if (++iter === realdata.length) {
                    interval.stop();
                    return;
                    }
            }, 750);
        }, timing);
        
        var text2params = {
            pos: [[1100,450]]
            ,scales: [1,3]
            ,id: "text2"
            ,textAreaWidth: 850
            ,textAreaHeight: 500
            //,textRelXPos: 0
            ,text: "Quick indebteness growth in Finland<br>after the financial crisis..."
            ,fontSize: 30
            //,textAlign: "center"
            ,fontFamily: "FontAwesome"
            //,pads: [20,20,20,0]
            ,rectStroke: "none"
            ,textColor: "#ef980b"
        };
        var text2 =  new TextField(text2params);
        timing = timing + 7000;        
        text2.Draw(timing, duration = 500);
        timing = timing + 4000;          
        text2.Hide(timing, duration = 500);

        var text3params = {
            pos: [[300,600]]
            ,scales: [1,3]
            ,id: "text3"
            ,textAreaWidth: 1000
            ,textAreaHeight: 500
            //,textRelXPos: 0
            ,text: "Property prices in Denmark are estimated to be quite<br>undervalued, hits bottom in 2012 Q2..."
            ,fontSize: 25
            //,textAlign: "center"
            ,fontFamily: "FontAwesome"
            //,pads: [20,20,20,0]
            ,rectStroke: "none"
            ,textColor: "#ef980b"
        };
        var text3 =  new TextField(text3params);
        timing = timing + 1000;        
        text3.Draw(timing, duration = 500);
        timing = timing + 7000;                
        text3.Hide(timing, duration = 500);


        var text4params = {
            pos: [[1300,700]]
            ,scales: [1,3]
            ,id: "text4"
            ,textAreaWidth: 500
            ,textAreaHeight: 500
            //,textRelXPos: 0
            ,text: "In Greece indebteness grows slowly but steadily, estimated undervaluation of properties becomes more distinct..."
            ,fontSize: 25
            //,textAlign: "center"
            ,fontFamily: "FontAwesome"
            //,pads: [20,20,20,0]
            ,rectStroke: "none"
            ,textColor: "#ef980b"
        };
        var text4 =  new TextField(text4params);
        timing = timing + 1000;        
        text4.Draw(timing, duration = 500);


        var text5params = {
            pos: [[1250,200]]
            ,scales: [1,3]
            ,id: "text5"
            ,textAreaWidth: 800
            ,textAreaHeight: 500
            //,textRelXPos: 0
            ,text: "Housing price bubble<br>brewing in Sweden..?"
            ,fontSize: 40
            //,textAlign: "center"
            ,fontFamily: "FontAwesome"
            //,pads: [20,20,20,0]
            ,rectStroke: "none"
            ,textColor: "#dd1a1a"
        };
        var text5 =  new TextField(text5params);
        timing = timing + 5000;           
        text5.Draw(timing, duration = 500);
        timing = timing + 7000;
        text4.Hide(timing, duration = 500);
    


        function interval_anim(datasetIn){
                function getQuarter(d) {
                    var m = d.getMonth() ;
                    var y = d.getFullYear().toString();

                    if (0 <= m & m <= 2){
                        return (y + "-Q1");
                    } else if (3 <= m & m <= 5) {
                        return (y + "-Q2");
                    } else if (6 <= m & m <= 8) {
                        return (y + "-Q3");
                    } else if (9 <= m & m <= 11) {
                        return (y + "-Q4");
                    }
                }            

                // Update circles
                plot.selectAll("circle")
                    .data(datasetIn)
                    .transition()
                    .duration(750) 
                    .delay(function(d, i) {
                        return i / datasetIn.length * 500;  // Dynamic delay (i.e. each item delays a little longer)
                        //return 0;                  
                    })
                    .ease(d3.easeLinear)
                    .attr("transform", function(d) {
                        return " translate(" + (xScale(d[2])) +","+ (yScale(d[0])) +") scale(" + maprange(d[1]) + ")"
                    })                    
                     

                console.log(getQuarter(currentDate))
                currentDate.setMonth(currentDate.getMonth()+3);
            }
      
});

addMathJax();



</script> 

</body>
</html>